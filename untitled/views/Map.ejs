<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Map Page</title>
    <!-- Naver Maps APIë¥¼ ë¡œë“œ -->
    <script type="text/javascript"
        src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=2j5bpft4t3&submodules=geocoder"></script>
    <link rel="stylesheet" href="/css/Map.css"> <!-- ìŠ¤íƒ€ì¼ ì‹œíŠ¸ ì—°ê²° -->
    <script src="/js/Map.js" defer></script> <!-- ì™¸ë¶€ JS íŒŒì¼ ì—°ê²° -->
</head>

<body>
    <!-- ì‚¬ì´ë“œë°” í† ê¸€ ë²„íŠ¼ -->
    <button class="toggle-button" id="toggleButton" onclick="toggleSidebar()" style="top: 20px; left: 20px;">â˜°</button>
    <!-- í™•ì¥ ì‚¬ì´ë“œë°” í† ê¸€ ë²„íŠ¼ -->
    <button class="toggle-button" id="toggleExtendedButton" onclick="toggleExtendedSidebar()"
        style="top: 20px; right: 20px;">â˜°</button>

    <!-- ê¸°ë³¸ ì‚¬ì´ë“œë°” -->
    <div class="sidebar" id="sidebar" style="display: none;">
        <button class="close-button" onclick="toggleSidebar()">Ã—</button>
        <h2>ê¸°ëŠ¥</h2>
        <div id="functionContainer">
            <ul>
                <li class="sidebar-element" onclick="showTravelInfo()">ì—¬í–‰ ì •ë³´ ë“±ë¡</li>
                <li class="sidebar-element" onclick="showRecommendedTravelInfo()">ì—¬í–‰ ì •ë³´ ì¶”ì²œ</li>
                <li class="sidebar-element" onclick="showUserInfo()">ì‚¬ìš©ì ì •ë³´</li>
            </ul>
        </div>
        <!-- ê²€ìƒ‰ ì»¨í…Œì´ë„ˆ -->
        <div class="search-container" id="searchContainer" style="display: none;">
            <button onclick="goBack()" style="margin-bottom: 10px;">ë’¤ë¡œê°€ê¸°</button>
            <div class="search-input-container">
                <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="width: calc(100% - 100px);">
                <button onclick="searchLocations()" style="width: 100px;">ê²€ìƒ‰</button>
            </div>
            <hr style="margin: 10px 0; border: 1px solid #ccc;">
            <div id="searchResults" class="results-container"></div> <!-- ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
        </div>
        <button class="logout-button" onclick="logout()" style="margin-top: auto;">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- í™•ì¥ëœ ì‚¬ì´ë“œë°” -->
    <div class="extended-sidebar" id="extendedSidebar" style="display: none;">
        <button class="close-button" onclick="toggleExtendedSidebar()">Ã—</button>
        <h2>ë“±ë¡ëœ ì •ë³´</h2>
        <button onclick="toggleMarkersAndRoute()">ë§ˆì»¤ì™€ ê²½ë¡œ í† ê¸€</button>
        <hr style="margin: 10px 0; border: 1px solid #ccc;">
        <div id="registeredInfoContainer" class="results-container"></div> <!-- ë“±ë¡ëœ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
        <input type="text" id="infoTitleInput" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”..." style="margin: 10px 0; width: 100%;">
        <textarea id="infoDetailsInput" placeholder="ì„¸ë¶€ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
            style="margin: 10px 0; width: 100%; height: 100px;"></textarea>
        <button onclick="saveRegisteredInfo()" style="margin-top: 10px;">ì €ì¥</button>
    </div>

    <!-- ì§€ë„ ì˜ì—­ -->
    <div id="map" style="width:100%;height:100%;"></div>

    <script>
        function reset() {
            // ëª¨ë“  ë§ˆì»¤ ì œê±°
            markers.forEach(marker => marker.setMap(null));
            markers = []; // ë§ˆì»¤ ë°°ì—´ ì´ˆê¸°í™”

            // í´ë¦¬ë¼ì¸ ì œê±°
            polyline.setPath([]); // í´ë¦¬ë¼ì¸ ê²½ë¡œ ì´ˆê¸°í™”
            polyline.setMap(null); // í´ë¦¬ë¼ì¸ ìˆ¨ê¸°ê¸°
            polylineVisible = false; // ê°€ì‹œì„± ìƒíƒœ ì´ˆê¸°í™”

            // ì§€ë„ ì´ˆê¸° ìœ„ì¹˜ ë° ì¤Œ ë ˆë²¨ ì„¤ì •
            map.setCenter(new naver.maps.LatLng(37.3595704, 127.105399)); // ì´ˆê¸° ìœ„ì¹˜ë¡œ ì¬ì„¤ì •
            map.setZoom(10); // ì´ˆê¸° ì¤Œ ë ˆë²¨ë¡œ ì¬ì„¤ì •
        }

        // ë§ˆì»¤ ì¶”ê°€ í•¨ìˆ˜
        function addMarker(latitude, longitude, title, thirdInfo, sixthInfo) {
            const marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(latitude, longitude),
                map: map, // ì§€ë„ì— ë§ˆì»¤ ì¶”ê°€
                title: title // ë§ˆì»¤ ì œëª© ì„¤ì •
            });

            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            naver.maps.Event.addListener(marker, 'click', function () {
                infoWindow.setContent(`<div style="text-align:center;">${title}</div>`);
                infoWindow.open(map, marker.getPosition());
            });

            // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì´ë²¤íŠ¸ ì¶”ê°€
            naver.maps.Event.addListener(marker, 'mouseover', function () {
                infoWindow.setContent(`
            <div style="text-align:left;">
                <strong style="font-size: 1.2em;">${title}</strong><br>
                <span style="font-size: 0.9em;">${thirdInfo}</span><br>
                <span style="font-size: 0.9em;">${sixthInfo}</span>
            </div>
        `);
                infoWindow.open(map, marker.getPosition());
            });

            // ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì´ë²¤íŠ¸ ì¶”ê°€
            naver.maps.Event.addListener(marker, 'mouseout', function () {
                infoWindow.close(); // ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì‹œ ì•Œë¦¼ì°½ ë‹«ê¸°
            });

            markers.push(marker); // ë°°ì—´ì— ë§ˆì»¤ ì¶”ê°€
        }

        // í´ë¦¬ë¼ì¸ì— ë§ˆì»¤ ê²½ë¡œ ì¶”ê°€ í•¨ìˆ˜
        function addPolylinePath(latitude, longitude) {
            const position = new naver.maps.LatLng(latitude, longitude);
            polyline.getPath().push(position); // í´ë¦¬ë¼ì¸ ê²½ë¡œì— ìœ„ì¹˜ ì¶”ê°€
            polyline.setMap(map); // í´ë¦¬ë¼ì¸ì„ ì§€ë„ì— í‘œì‹œ
        }

        // ì¶”ì²œ ì—¬í–‰ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
        function showRecommendedTravelInfo() {
            // ëª¨ë“  ìš”ì†Œ ë¹„í™œì„±í™”
            document.getElementById('functionContainer').style.display = 'none';
            document.getElementById('searchContainer').style.display = 'block'; // ê²€ìƒ‰ ì»¨í…Œì´ë„ˆ ë³´ì—¬ì£¼ê¸°

            // ê²€ìƒ‰ ë²„íŠ¼ê³¼ ê²€ìƒ‰ í…ìŠ¤íŠ¸ ì…ë ¥ ìƒìë¥¼ ìˆ¨ê¹€
            document.getElementById('searchInput').style.display = 'none'; // ê²€ìƒ‰ í…ìŠ¤íŠ¸ ì…ë ¥ ìƒì ìˆ¨ê¹€
            const searchButton = document.querySelector('.search-input-container button');
            if (searchButton) {
                searchButton.style.display = 'none'; // ê²€ìƒ‰ ë²„íŠ¼ ìˆ¨ê¹€
            }

            const resultsContainer = document.getElementById('searchResults');
            // ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
            resultsContainer.innerHTML = '';

            // Ajax ìš”ì²­ì„ í†µí•´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤ê³  ê°€ì •
            fetch('/registered_info')
                .then(response => response.json())
                .then(data => {
                    data.forEach(item => {
                        // ë°ì´í„° í•­ëª©ì„ ë³´ì—¬ì£¼ëŠ” HTML ìƒì„±
                        const resultItem = document.createElement('div');
                        resultItem.classList.add('result-item');

                        // detailì´ 3ì¤„ì„ ì´ˆê³¼í•˜ë©´ ì˜ë¼ì£¼ëŠ” í•¨ìˆ˜
                        const truncatedDetail = truncateDetail(item.detail);

                        resultItem.innerHTML = `
                    <h3>${item.title}</h3>
                    <p>${truncatedDetail}</p>
                `;

                        // í´ë¦­ ì‹œ ë§ˆì»¤ ë° í´ë¦¬ë¼ì¸ ì¶”ê°€
                        resultItem.onclick = function () {
                            // ì´ì „ ë§ˆì»¤ ë° í´ë¦¬ë¼ì¸ ì´ˆê¸°í™”
                            reset();
                            const sections = item.info.split('@@');

                            let message = ''; // ì•Œë¦¼ì°½ì— í‘œì‹œí•  ë©”ì‹œì§€

                            sections.forEach(section => {
                                const details = section.split('##');
                                if (details.length >= 5) { // ë„¤ ë²ˆì§¸ì™€ ë‹¤ì„¯ ë²ˆì§¸ ìš”ì†Œê°€ ìˆëŠ”ì§€ í™•ì¸
                                    const latitude = parseFloat(details[4]) / 10000000; // ë‹¤ì„¯ ë²ˆì§¸ ìš”ì†Œ (ê²½ë„) ê°€ê³µ
                                    const longitude = parseFloat(details[3]) / 10000000; // ë„¤ ë²ˆì§¸ ìš”ì†Œ (ìœ„ë„) ê°€ê³µ

                                    // ë§ˆì»¤ì™€ í´ë¦¬ë¼ì¸ ì¶”ê°€
                                    addMarker(latitude, longitude, details[0], details[2], details[5]); // ì œëª©ìœ¼ë¡œ ë§ˆì»¤ì— ë ˆì´ë¸” ì¶”ê°€
                                    addPolylinePath(latitude, longitude); // í´ë¦¬ë¼ì¸ ê²½ë¡œì— ìœ„ì¹˜ ì¶”ê°€

                                    // ì•Œë¦¼ì°½ ë©”ì‹œì§€ì— ìœ„ì¹˜ ì •ë³´ ì¶”ê°€
                                    message += `ì œëª©: ${details[0]}\nìœ„ë„: ${latitude}\nê²½ë„: ${longitude}\n\n`;
                                }
                            });

                            // ìœ„ì¹˜ ì •ë³´ë¥¼ ì•Œë¦¼ì°½ìœ¼ë¡œ í‘œì‹œ
                            alert(message || 'ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        };

                        resultsContainer.appendChild(resultItem);
                    });
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // detailì„ ì˜ë¼ì£¼ëŠ” í•¨ìˆ˜
        function truncateDetail(detail) {
            const lines = detail.split('\n'); // ì¤„ë°”ê¿ˆ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ„ê¸°
            if (lines.length > 3) {
                return lines.slice(0, 3).join('\n') + '...'; // 3ì¤„ ì´ˆê³¼ ì‹œ '...' ì¶”ê°€
            }
            return detail; // 3ì¤„ ì´ë‚´ëŠ” ê·¸ëŒ€ë¡œ ë°˜í™˜
        }

        // ì¶”ê°€ì ì¸ ì‚¬ì´ë“œë°” ì—´ê¸° ë° ë‹«ê¸°
        function toggleExtendedSidebar() {
            const extendedSidebar = document.getElementById('extendedSidebar');
            const isVisible = extendedSidebar.style.display === 'block'; // í˜„ì¬ ë³´ì´ëŠ”ì§€ ì—¬ë¶€ í™•ì¸

            if (isVisible) {
                extendedSidebar.style.display = 'none'; // ë³´ì´ë©´ ìˆ¨ê¹€
            } else {
                extendedSidebar.style.display = 'block'; // ë³´ì´ì§€ ì•Šìœ¼ë©´ ë³´ì—¬ì¤Œ
            }
        }
    </script>
</body>

</html>
